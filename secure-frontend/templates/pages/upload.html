{% extends "dashboard_layout.html" %}

{% block title %}Upload Documents - Secure Portal{% endblock %}

{% block breadcrumbs %}Upload Documents{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8" x-data="uploadHandler">
    <!-- Header -->
    <div class="flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-bold tracking-tight" style="font-family: var(--font-display);">
                Upload Documents
            </h1>
            <p class="text-secondary">Securely upload and manage your files.</p>
        </div>
    </div>

    <!-- Upload Area -->
    <div class="glass-panel p-8 rounded-3xl text-center space-y-6 border-dashed border-2 border-white/20 hover:border-primary/50 transition-colors"
         @dragover.prevent="dragOver = true"
         @dragleave.prevent="dragOver = false"
         @drop.prevent="handleDrop($event)"
         :class="{ 'bg-white/10 border-primary': dragOver }">
        
        <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        </div>

        <div class="space-y-2">
            <h3 class="text-xl font-bold">Drag & Drop files here</h3>
            <p class="text-secondary text-sm">or click to browse from your computer</p>
        </div>

        <input type="file" id="fileInput" multiple class="hidden" @change="handleFiles($event.target.files)">
        
        <button class="btn-primary" @click="document.getElementById('fileInput').click()">
            Select Files
        </button>

        <p class="text-xs text-tertiary">
            Supported formats: PDF, JPG, PNG, MP4 â€¢ Max size: 20MB per file
        </p>
    </div>

    <!-- File List & Progress -->
    <div class="space-y-4" x-show="files.length > 0" x-transition>
        <div class="flex justify-between items-center">
            <h3 class="font-bold text-lg">Upload Queue</h3>
            <span class="text-sm text-secondary" x-text="`${files.length} file${files.length > 1 ? 's' : ''} selected`"></span>
        </div>

        <div class="space-y-3">
            <template x-for="(file, index) in files" :key="index">
                {% include "components/upload_progress.html" %}
            </template>
        </div>

        <div class="flex justify-end gap-4 pt-4">
            <button class="btn-secondary" @click="files = []" x-show="!uploading">Clear All</button>
            <button class="btn-primary" @click="uploadFiles()" :disabled="uploading || files.length === 0">
                <span x-show="!uploading">Start Upload</span>
                <span x-show="uploading">Uploading...</span>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('uploadHandler', () => ({
            dragOver: false,
            uploading: false,
            files: [],

            handleDrop(event) {
                this.dragOver = false;
                const droppedFiles = event.dataTransfer.files;
                this.handleFiles(droppedFiles);
            },

            handleFiles(fileList) {
                for (let i = 0; i < fileList.length; i++) {
                    const file = fileList[i];
                    // Validate size (20MB)
                    if (file.size > 20 * 1024 * 1024) {
                        alert(`File ${file.name} is too large (max 20MB)`);
                        continue;
                    }
                    
                    this.files.push({
                        file: file,
                        name: file.name,
                        size: this.formatSize(file.size),
                        progress: 0,
                        status: 'pending', // pending, uploading, success, error
                        message: ''
                    });
                }
            },

            formatSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            removeFile(index) {
                this.files.splice(index, 1);
            },

            async uploadFiles() {
                this.uploading = true;
                
                for (let i = 0; i < this.files.length; i++) {
                    const fileObj = this.files[i];
                    if (fileObj.status === 'success') continue;

                    fileObj.status = 'uploading';
                    fileObj.progress = 0;

                    const formData = new FormData();
                    formData.append('file', fileObj.file);

                    try {
                        const xhr = new XMLHttpRequest();
                        
                        // Create a promise to handle the XHR upload
                        await new Promise((resolve, reject) => {
                            xhr.upload.addEventListener('progress', (e) => {
                                if (e.lengthComputable) {
                                    fileObj.progress = Math.round((e.loaded / e.total) * 100);
                                }
                            });

                            xhr.addEventListener('load', () => {
                                if (xhr.status >= 200 && xhr.status < 300) {
                                    fileObj.status = 'success';
                                    fileObj.progress = 100;
                                    resolve();
                                } else {
                                    fileObj.status = 'error';
                                    fileObj.message = 'Upload failed';
                                    reject(new Error(xhr.statusText));
                                }
                            });

                            xhr.addEventListener('error', () => {
                                fileObj.status = 'error';
                                fileObj.message = 'Network error';
                                reject(new Error('Network error'));
                            });

                            xhr.open('POST', '/documents/upload');
                            xhr.send(formData);
                        });

                    } catch (error) {
                        console.error('Upload failed:', error);
                    }
                }

                this.uploading = false;
                
                // If all successful, show message or redirect
                if (this.files.every(f => f.status === 'success')) {
                    setTimeout(() => {
                        window.location.href = '/documents';
                    }, 1000);
                }
            }
        }));
    });
</script>
{% endblock %}
